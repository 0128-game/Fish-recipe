<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>魚料理レシピ一覧</title>
<style>
  :root{
    --bg:#f6f7fb;
    --card:#ffffff;
    --accent:#2b6cb0;
    --muted:#666;
    --success:#2f855a;
    --danger:#c53030;
    --max-width:1200px;
  }
  *{box-sizing:border-box}
  body{
    font-family: "Hiragino Kaku Gothic ProN", "Yu Gothic", "Meiryo",sans-serif;
    margin:0;
    background:var(--bg);
    color:#222;
    padding:20px;
    display:flex;
    justify-content:center;
  }
  .wrap{
    width:100%;
    max-width:var(--max-width);
  }
  header{
    display:flex;
    gap:12px;
    align-items:flex-start;
    margin-bottom:18px;
  }
  header h1{margin:0;font-size:1.3rem}
  .controls{
    margin-left:auto;
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    align-items:center;
  }
  input[type="search"], select{
    padding:8px 10px;
    border-radius:8px;
    border:1px solid #d6d8df;
    background:white;
  }
  button{
    padding:8px 12px;
    border-radius:8px;
    border:none;
    background:var(--accent);
    color:white;
    cursor:pointer;
  }
  button:disabled{opacity:.6;cursor:not-allowed}
  main{
    background:transparent;
  }
  table{
    width:100%;
    border-collapse:collapse;
    background:var(--card);
    border-radius:10px;
    overflow:hidden;
    box-shadow:0 6px 18px rgba(20,20,40,0.06);
  }
  thead th{
    text-align:left;
    padding:10px 12px;
    font-size:0.85rem;
    background:#f1f5f9;
    border-bottom:1px solid #eee;
    position:sticky;
    top:0;
    z-index:1;
  }
  tbody td{
    padding:10px 12px;
    border-bottom:1px dashed #eee;
    vertical-align:top;
    font-size:0.95rem;
  }
  tbody tr:hover{background:rgba(43,108,176,0.03)}
  .muted{color:var(--muted);font-size:0.85rem}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef5ff;color:var(--accent);font-size:0.8rem}
  .actions button{margin-right:6px}
  .tag-type{padding:4px 8px;border-radius:6px;font-size:0.8rem}
  .type-recipe{background:#fff7ed;color:#b45309;border:1px solid #f6e7d0}
  .type-pre{background:#f0fff4;color:#2f855a;border:1px solid #d6f7df}

  /* ★ Picture列用スタイル追加 */
  table th:nth-child(3),
  table td:nth-child(3) {
    width:70px; 
    text-align:center;
  }

  /* modal */
  .modal-backdrop{
    position:fixed;inset:0;background:rgba(12,18,30,0.45);display:none;align-items:center;justify-content:center;padding:20px;z-index:1000;
  }
  .modal{
    width:100%;max-width:760px;background:var(--card);border-radius:12px;padding:18px;box-shadow:0 10px 30px rgba(10,20,40,0.25);
    max-height:90vh;overflow:auto;
  }
  .modal h2{margin:0 0 8px 0}
  .modal .meta{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:8px}
  .grid{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:12px;
  }
  .section-title{font-weight:700;margin:10px 0 6px 0}
  ul{margin:6px 0 12px 20px}
  pre{white-space:pre-wrap;background:#f8fafc;padding:10px;border-radius:8px;border:1px solid #eef2f7}
  .small{font-size:0.85rem;color:var(--muted)}
  footer{margin-top:14px;display:flex;justify-content:space-between;align-items:center;gap:10px}
  @media (max-width:700px){
    .grid{grid-template-columns:1fr}
    header{align-items:center}
  }
  .notice{padding:12px;border-radius:8px;background:#fff3f3;color:var(--danger);border:1px solid rgba(197,48,48,0.12);margin-bottom:12px}
</style>

</head>
<body>
 <div class="wrap" id="app">
   <header>
     <h1>魚料理レシピ一覧</h1>
     <div class="controls" aria-hidden="false">
       <label class="small" for="q">検索:</label>
       <input id="q" type="search" placeholder="タイトル・魚名・特徴などを検索">
       <label class="small" for="filterType">タイプ:</label>
       <select id="filterType">
         <option value="all">すべて</option>
         <option value="recipe">料理 (recipe)</option>
         <option value="pre">下処理 (pre)</option>
       </select>
       <label class="small" for="sortBy">並び替え:</label>
       <select id="sortBy">
         <option value="No">No（昇順）</option>
         <option value="-No">No（降順）</option>
         <option value="cost">費用（昇順）</option>
         <option value="-cost">費用（降順）</option>
         <option value="time">所要時間（昇順）</option>
         <option value="-time">所要時間（降順）</option>
       </select>
       <button id="reloadBtn" title="再読み込み">再読み込み</button>
     </div>
   </header>

   <main>
     <div id="message" role="status" aria-live="polite" style="margin-bottom:10px"></div>

     <div style="overflow:auto;border-radius:10px">
       <table id="recipeTable" aria-describedby="message">
         <thead>
           <tr>
             <th style="width:70px">No</th>
             <th style="width:80px">Type</th>
             <th style="width:70px">Picture</th>
             <th>Title / flavortxt</th>
             <th style="width:160px">魚 / 旬</th>
             <th style="width:120px">難易度 / 時間</th>
             <th style="width:120px">費用 / 下処理参照</th>
             <th style="width:110px">操作</th>
           </tr>
         </thead>
         <tbody id="tbody"></tbody>
       </table>
     </div>
   </main>
 </div>

<script>
(async function(){
  const tryPaths = ['docs/recipes.json','./docs/recipes.json','/recipes.json','./recipes.json'];
  const tbody = document.getElementById('tbody');
  const qInput = document.getElementById('q');
  const filterType = document.getElementById('filterType');
  const sortBy = document.getElementById('sortBy');
  const reloadBtn = document.getElementById('reloadBtn');
  const message = document.getElementById('message');
  let rawData=null, flatList=[];

  function elText(tag,text,cls){
    const e=document.createElement(tag); if(cls)e.className=cls;
    e.textContent=text||''; return e;
  }

  async function fetchAny(paths){
    for(const p of paths){
      try{const r=await fetch(p,{cache:"no-store"}); if(r.ok)return await r.json();}catch(e){console.warn(e);}
    } throw new Error('recipes.json を見つけられません');
  }

  function buildFlatList(data){
    const list=[];
    if(!data||typeof data!=='object')return list;
    const recipes=data.recipes||{};
    for(const key of Object.keys(recipes)){const item=Object.assign({},recipes[key]); item._type='recipe'; item.No=item.No!=null?String(item.No):String(key); list.push(item);}
    const pres=data.preparations||{};
    for(const key of Object.keys(pres)){const item=Object.assign({},pres[key]); item._type='pre'; item.No=item.No!=null?String(item.No):String(key); list.push(item);}
    return list;
  }

  function joinIfArray(val){ if(Array.isArray(val))return val.join(', '); if(val==null)return ''; return String(val); }

  function clearTable(){ tbody.innerHTML=''; }

  function renderTable(list){
    clearTable();
    if(!Array.isArray(list)||list.length===0){
      tbody.innerHTML='<tr><td colspan="8" class="muted" style="padding:20px;text-align:center">表示するレシピがありません。</td></tr>';
      return;
    }
    const frag=document.createDocumentFragment();
    for(const item of list){
      const tr=document.createElement('tr');
      // No
      tr.appendChild(elText('td',item.No||'-'));
      // Type
      const tdType=document.createElement('td');
      const span=document.createElement('span'); span.className='tag-type '+(item._type==='pre'?'type-pre':'type-recipe'); span.textContent=item._type;
      tdType.appendChild(span); tr.appendChild(tdType);
      // Picture
      const tdPic=document.createElement('td'); tdPic.textContent=(Array.isArray(item.pictures)&&item.pictures.length>0)?'画像あり':'—'; tdPic.className='muted'; tr.appendChild(tdPic);
      // Title / flavortxt
      const tdTitle=document.createElement('td'); tdTitle.appendChild(elText('div',item.title||'(タイトルなし)')); tdTitle.appendChild(elText('div',item.flavortxt||'','muted')); tr.appendChild(tdTitle);
      // fish / season
      const tdFish=document.createElement('td'); tdFish.appendChild(elText('div',joinIfArray(item['fish-name'])||'-')); tdFish.appendChild(elText('div',joinIfArray(item.season)||'','muted')); tr.appendChild(tdFish);
      // difficulty / time
      const tdDiff=document.createElement('td'); tdDiff.appendChild(elText('div','難易度: '+(item.difficulty!=null?item.difficulty:'-'))); tdDiff.appendChild(elText('div','所要: '+(item.time!=null?item.time+'分':'-'),'muted')); tr.appendChild(tdDiff);
      // cost / pre-recipe
      const tdCost=document.createElement('td'); tdCost.appendChild(elText('div','¥'+(item.cost!=null?item.cost:'-'))); tdCost.appendChild(elText('div','参照: '+(item['pre-recipe']||'-'),'muted')); tr.appendChild(tdCost);
      // actions
      const tdActions=document.createElement('td'); tdActions.className='actions';
      const viewBtn=document.createElement('button'); viewBtn.textContent='詳細'; tdActions.appendChild(viewBtn);
      tr.appendChild(tdActions);
      frag.appendChild(tr);
    }
    tbody.appendChild(frag);
  }

  function applyFiltersAndRender(){
    const q=(qInput.value||'').trim().toLowerCase();
    const type=filterType.value;
    let list=flatList.slice();
    if(type!=='all') list=list.filter(i=>i._type===type);
    if(q) list=list.filter(item=>{
      const hay=[item.title,item.flavortxt,joinIfArray(item['fish-name']),joinIfArray(item.feature),joinIfArray(item.season),item.No].filter(Boolean).join(' ').toLowerCase();
      return hay.indexOf(q)!==-1;
    });
    renderTable(list);
  }

  reloadBtn.addEventListener('click',()=>loadData());
  qInput.addEventListener('input',()=>applyFiltersAndRender());
  filterType.addEventListener('change',()=>applyFiltersAndRender());
  sortBy.addEventListener('change',()=>applyFiltersAndRender());

  async function loadData(){
    message.textContent='読み込み中...';
    try{
      const json=await fetchAny(tryPaths);
      rawData=json;
      flatList=buildFlatList(json);
      message.textContent=`読み込み完了 — 合計 ${flatList.length} 件`;
      applyFiltersAndRender();
    }catch(e){
      message.innerHTML='<div class="notice">読み込みエラー: '+String(e.message)+'</div>';
      clearTable();
    }
  }

  loadData();
})();
</script>
</body>
</html>
