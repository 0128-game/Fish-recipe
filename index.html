<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>é­šæ–™ç†ãƒ¬ã‚·ãƒ”ä¸€è¦§</title>
<style>
/* * å…¨æ©Ÿèƒ½å¯¾å¿œã®çµ±åˆCSSã‚¹ã‚¿ã‚¤ãƒ«
 * ãƒ¬ã‚·ãƒ”ãƒªã‚¹ãƒˆã€è©³ç´°ã€ææ¡ˆç”»é¢ã®åˆ‡ã‚Šæ›¿ãˆã€ãƒœã‚¿ãƒ³ã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã€ã‚¿ã‚°è¡¨ç¤ºã«å¯¾å¿œã€‚
 */

/* === 1. åŸºæœ¬è¨­å®šã¨å¤‰æ•° === */
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 20px;
    background-color: #f7fafc; /* è–„ã„ã‚°ãƒ¬ãƒ¼ã®èƒŒæ™¯ */
    color: #2d3748;
}

:root {
    --accent: #48bb78; /* ãƒ¡ã‚¤ãƒ³ã‚«ãƒ©ãƒ¼ (ã‚°ãƒªãƒ¼ãƒ³ç³») */
    --primary: #4299e1; /* ã‚»ã‚«ãƒ³ãƒ€ãƒªã‚«ãƒ©ãƒ¼ (ãƒ–ãƒ«ãƒ¼ç³») */
    --danger: #e53e3e; /* è­¦å‘Š/å‰Šé™¤ã‚«ãƒ©ãƒ¼ (ãƒ¬ãƒƒãƒ‰ç³») */
    --card: #ffffff;
    --border: #e2e8f0;
}

#wrap {
    max-width: 1200px;
    margin: 0 auto;
    transition: all 0.5s ease;
}

h1, h2 {
    color: #2d3748;
}

/* === 2. ãƒ“ãƒ¥ãƒ¼ã®æ’ä»–åˆ¶å¾¡ === */
/* JSãŒè¨­å®šã™ã‚‹ã‚¯ãƒ©ã‚¹ã«åŸºã¥ã„ã¦ã€ç”»é¢å…¨ä½“ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ */
#listContainer, #detailContainer, #recommendContainer {
    display: none;
    padding-top: 20px;
}
#wrap.list-view #listContainer { display: block; }
#wrap.detail-view #detailContainer { display: block; }
#wrap.recommend-view #recommendContainer { display: block; }

/* === 3. ãƒ•ã‚©ãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã¨ãƒœã‚¿ãƒ³ === */
.controls-area {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}
.controls-area input, .controls-area select {
    padding: 10px;
    border: 1px solid var(--border);
    border-radius: 4px;
    font-size: 1em;
}

/* å…¨ã¦ã®ãƒœã‚¿ãƒ³ã«é©ç”¨ã™ã‚‹åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
.action-buttons-group button, .back-btn, #recommendOpenBtn, #reloadBtn, button {
    padding: 10px 15px;
    border-radius: 4px;
    border: 1px solid #cbd5e0;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.2s, transform 0.1s;
}
button:active {
    transform: scale(0.98);
}

/* ä¸»è¦ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
#recommendOpenBtn, #filterOpenBtn, #applyFilterBtn, #filterClearBtn {
    color: white;
    border: none !important;
}

#recommendOpenBtn { background-color: var(--accent); }
#recommendOpenBtn:hover { background-color: #38a169; }

#filterOpenBtn { background-color: var(--primary); }
#filterOpenBtn:hover { background-color: #3182ce; }

#applyFilterBtn { background-color: var(--accent); }
#applyFilterBtn:hover { background-color: #38a169; }

#filterClearBtn { background-color: var(--danger); }
#filterClearBtn:hover { background-color: #c53030; }

/* æˆ»ã‚‹ãƒœã‚¿ãƒ³ */
.back-btn, #backToListBtn, #backToRecommendBtn {
    background-color: var(--card);
    color: #4a5568;
    border: 1px solid #a0aec0;
}
.back-btn:hover { background-color: #edf2f7; }

/* === 4. ãƒ¬ã‚·ãƒ”ãƒªã‚¹ãƒˆï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰ === */
#recipeTable {
    width: 100%;
    border-collapse: collapse;
    background-color: var(--card);
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}
#recipeTable th, #recipeTable td {
    padding: 12px 10px;
    border: 1px solid var(--border);
    text-align: left;
    vertical-align: middle;
}
#recipeTable th {
    background-color: #edf2f7;
    font-size: 0.9em;
    font-weight: 600;
}
#recipeTable tr:hover {
    background-color: #fafafa;
}
.recipe-thumb {
    width: 80px; 
    height: 60px; 
    object-fit: cover;
    border-radius: 3px;
}

/* --- ãƒªã‚¹ãƒˆå†…ã®ã‚¿ã‚°/ãƒ©ãƒ™ãƒ« --- */
.tag-type {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    font-weight: 600;
}
.type-recipe { background-color: #e6fffa; color: #319795; }
.type-pre { background-color: #fff5f5; color: var(--danger); }
.muted { color: #718096; font-size: 0.9em; }

/* === 5. è©³ç´°ãƒ“ãƒ¥ãƒ¼ === */
#detailContainer h1 { margin-bottom: 5px; }
#detailContainer h2 { 
    margin-top: 30px; 
    border-bottom: 2px solid var(--border);
    padding-bottom: 5px;
}

/* ãƒ¡ã‚¿æƒ…å ±ãƒ”ãƒ« */
#detailMeta {
    margin: 15px 0;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}
#detailMeta .pill {
    background-color: #e2e8f0;
    padding: 7px 12px;
    border-radius: 20px;
    font-size: 0.85em;
    font-weight: 600;
}
.pre-link-pill {
    background-color: #fffff0;
    color: #b7791f;
    border: 1px solid #fbd38d;
}

/* è©³ç´°ãƒªã‚¹ãƒˆï¼ˆææ–™ã€æ‰‹é †ã€ãƒ¡ãƒ¢ï¼‰ */
#detailIngredients, #detailProps, #detailMemo {
    background-color: #ffffff;
    padding: 15px;
    border: 1px solid var(--border);
    border-radius: 6px;
}
#detailIngredients ul, #detailProps ul, #detailMemo ul {
    list-style: none;
    padding-left: 0;
    margin: 0;
}
#detailIngredients li, #detailProps li, #detailMemo li {
    padding: 5px 0;
    border-bottom: 1px dotted #e2e8f0;
}
#detailIngredients li:last-child, #detailProps li:last-child, #detailMemo li:last-child {
    border-bottom: none;
}

/* æ‰‹é †ã‚«ãƒ¼ãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
#detailRecipe {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
}
.recipe-step-card {
    background: var(--card);
    border: 1px solid #dee2e6;
    padding: 15px;
    border-radius: 6px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}
.recipe-step-card p {
    margin-top: 10px;
}

/* === 6. ãŠã™ã™ã‚ææ¡ˆãƒ“ãƒ¥ãƒ¼ === */
#recommendOptions {
    background-color: #fff;
    padding: 20px;
    border: 1px solid var(--border);
    border-radius: 8px;
}
#recommendOptions h3 {
    margin-top: 0;
}

.recommend-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}
.recommend-card {
    background-color: var(--card);
    border: 1px solid #ddd;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    cursor: pointer;
    transition: box-shadow 0.2s, background-color 0.2s;
}
.recommend-card:hover {
    background-color: #f7fafc;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15) !important;
}

/* === 7. ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« === */
#filterModal {
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background: rgba(0,0,0,0.6); /* æš—ã„ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    justify-content: center; 
    align-items: center; 
    z-index: 100;
    /* JSã«ã‚ˆã£ã¦ display: flex; ãŒè¨­å®šã•ã‚Œã‚‹ */
}
#filterModal > div {
    background: white; 
    padding: 30px; 
    border-radius: 8px; 
    max-width: 600px; 
    width: 90%; 
    max-height: 90%; 
    overflow-y: auto;
    box-shadow: 0 10px 20px rgba(0,0,0,0.2);
}

.filter-group {
    border: 1px solid var(--border);
    padding: 15px;
    border-radius: 6px;
    margin-bottom: 15px;
}
.filter-group legend {
    font-weight: bold;
    padding: 0 10px;
    color: #4a5568;
}
.filter-hint {
    font-size: 0.85em;
    color: #718096;
    margin-top: 0;
    padding-bottom: 10px;
    border-bottom: 1px dotted var(--border);
}

/* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®é¸æŠè‚¢ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
.radio-options-container {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
}
.filter-group .filter-item {
    display: flex;
    align-items: center;
    gap: 5px;
}
.filter-item label {
    font-weight: normal;
    cursor: pointer;
}
.filter-input-container {
    display: flex;
    align-items: center;
    gap: 10px;
    padding-top: 10px;
    border-top: 1px dashed var(--border);
    margin-top: 10px;
}

/* === 8. ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ (ç°¡æ˜“) === */
@media (max-width: 768px) {
    body {
        padding: 10px;
    }
    .controls-area {
        flex-direction: column;
    }
    .action-buttons-group {
        flex-direction: column;
    }
    #recipeTable th, #recipeTable td {
        padding: 8px 5px;
        font-size: 0.85em;
    }
    /* ãƒ¢ãƒã‚¤ãƒ«ã§ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¡¨ç¤ºèª¿æ•´ */
    #recipeTable th:nth-child(3), #recipeTable td:nth-child(3), /* ç”»åƒ */
    #recipeTable th:nth-child(5), #recipeTable td:nth-child(5) { /* é­šç¨®/æ—¬ */
        display: none;
    }
}
</style>

<div id="wrap" class="list-view"> 

    <div id="listContainer" class="view-section">
        <header>
            <h1>ğŸŸ é­šãƒ¬ã‚·ãƒ”ãƒ»ä¸‹å‡¦ç†æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ </h1>
            <p id="message">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        </header>

        <div class="controls-area" style="display: flex; gap: 10px; margin-bottom: 20px;">
            <input type="text" id="q" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢" style="flex: 2;">
            
            <select id="filterType" style="flex: 1;">
                <option value="all">ã™ã¹ã¦</option>
                <option value="recipe">ãƒ¬ã‚·ãƒ”ã®ã¿</option>
                <option value="pre">ä¸‹å‡¦ç†ã®ã¿</option>
            </select>

            <select id="sortBy" style="flex: 1;">
                <option value="-No">No. (é™é †)</option>
                <option value="No">No. (æ˜‡é †)</option>
                <option value="-difficulty">é›£æ˜“åº¦ (é«˜é †)</option>
                <option value="difficulty">é›£æ˜“åº¦ (ä½é †)</option>
                <option value="title">ã‚¿ã‚¤ãƒˆãƒ«</option>
            </select>
        </div>

        <div class="action-buttons-group" style="margin-bottom: 20px; display: flex; gap: 10px;">
            <button id="filterOpenBtn" style="padding: 10px 15px; background-color: #63b3ed; color: white; border: none; border-radius: 4px; cursor: pointer;">ğŸ” è©³ç´°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</button>
            
            <button id="recommendOpenBtn" class="action-btn" style="padding: 10px 15px; background-color: #48bb78; color: white; border: none; border-radius: 4px; cursor: pointer;">âœ¨ ãŠã™ã™ã‚ãƒ¬ã‚·ãƒ”ææ¡ˆ</button>
        </div>

        <table id="recipeTable" style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr>
                    <th>No.</th>
                    <th>ç¨®é¡</th>
                    <th>ç”»åƒ</th>
                    <th>ã‚¿ã‚¤ãƒˆãƒ«/èª¬æ˜</th>
                    <th>é­šç¨®/æ—¬</th>
                    <th>é›£æ˜“åº¦/æ‰€è¦æ™‚é–“</th>
                    <th>è²»ç”¨/æƒ…å ±</th>
                    <th>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
                </tr>
            </thead>
            <tbody id="tbody">
                </tbody>
        </table>
    </div>

    <div id="detailContainer" class="view-section" style="display: none;">
        <button id="backToListBtn" style="margin-bottom: 20px;">â† ãƒªã‚¹ãƒˆã«æˆ»ã‚‹</button>

        <h1 id="detailTitle"></h1>
        <p id="detailSubtitle" style="color: #4a5568;"></p>

        <div id="detailMeta" style="margin: 15px 0; display: flex; flex-wrap: wrap; gap: 8px;">
            </div>

        <div id="detailImageContainer" style="margin: 20px 0; text-align: center;">
            </div>

        <h2>ææ–™</h2>
        <div id="detailIngredients" style="margin-bottom: 20px; padding: 10px; border: 1px solid #ddd;">
            </div>

        <section id="propsSection">
            <h2>é“å…·</h2>
            <div id="detailProps" style="margin-bottom: 20px; padding: 10px; border: 1px solid #ddd;">
                </div>
        </section>

        <h2>æ‰‹é †</h2>
        <div id="detailRecipe" style="margin-bottom: 20px;">
            </div>

        <h2>ãƒ¡ãƒ¢</h2>
        <div id="detailMemo" style="padding: 10px; border: 1px dashed #ddd;">
            </div>
    </div>

    <div id="recommendContainer" class="view-section" style="display: none;">
        <button id="backToRecommendBtn" class="back-btn" style="margin-bottom: 20px;">â† ãƒ¬ã‚·ãƒ”ãƒªã‚¹ãƒˆã«æˆ»ã‚‹</button>
        
        <h1>ãŠã™ã™ã‚ãƒ¬ã‚·ãƒ”ææ¡ˆ</h1>

        <div id="recommendOptions" style="margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 8px;">
            </div>
        
        <div id="recommendResult" style="margin-top: 30px;">
            </div>
    </div>
</div>

<div id="filterModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 100; display: none;">
    <div style="background: white; padding: 30px; border-radius: 8px; max-width: 600px; width: 90%; max-height: 90%; overflow-y: auto;">
        <h2>è©³ç´°çµã‚Šè¾¼ã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</h2>
        
        <div id="filterContent" style="margin: 20px 0;">
            </div>
        
        <div style="display: flex; justify-content: flex-end; gap: 10px;">
            <button id="filterClearBtn" style="background-color: #e53e3e; color: white;">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¯ãƒªã‚¢</button>
            <button id="applyFilterBtn" style="background-color: #38a169; color: white;">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨ã—ã¦é–‰ã˜ã‚‹</button>
        </div>
    </div>
</div>

<button id="reloadBtn" style="position: fixed; bottom: 20px; right: 20px; padding: 10px; z-index: 101;">ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿</button>

<script>
/*
 * æœ€çµ‚çµ±åˆç‰ˆ: ãƒ¬ã‚·ãƒ”ãƒªã‚¹ãƒˆã€è©³ç´°è¡¨ç¤ºã€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã€ãŠã™ã™ã‚ææ¡ˆæ©Ÿèƒ½ã‚’çµ±åˆã€‚
 * é­šç¨®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ (b âŠ† a)ã€ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›ã€çµã‚Šè¾¼ã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ä¸‹å‡¦ç†ã«é©ç”¨ã€
 * ææ¡ˆç”»é¢ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã‚’å‹•çš„è¿½åŠ æ¸ˆã¿ã€‚
 */

(function(){
    const tryPaths = [
        'docs/recipes.json',
        './docs/recipes.json',
        '/recipes.json',
        './recipes.json'
    ];

    // â˜…â˜…â˜… å…±é€šè¦ç´  â˜…â˜…â˜…
    const wrap = document.getElementById('wrap');
    
    // â˜…â˜…â˜… ãƒªã‚¹ãƒˆç”»é¢ã®è¦ç´  â˜…â˜…â˜…
    const tbody = document.getElementById('tbody');
    const qInput = document.getElementById('q');
    const filterType = document.getElementById('filterType');
    const sortBy = document.getElementById('sortBy');
    const reloadBtn = document.getElementById('reloadBtn');
    const message = document.getElementById('message');
    const backToRecommendBtn = document.getElementById('backToRecommendBtn'); // ãƒªã‚¹ãƒˆã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ (ææ¡ˆç”»é¢ã‹ã‚‰ç”¨)

    // â˜…â˜…â˜… ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´  â˜…â˜…â˜…
    const filterOpenBtn = document.getElementById('filterOpenBtn'); 
    const filterModal = document.getElementById('filterModal');     
    const filterContent = document.getElementById('filterContent'); 
    const applyFilterBtn = document.getElementById('applyFilterBtn'); 
    const filterClearBtn = document.getElementById('filterClearBtn'); 
    
    // â˜…â˜…â˜… è©³ç´°ç”»é¢ã®è¦ç´  â˜…â˜…â˜…
    const detailTitle = document.getElementById('detailTitle');
    const detailSubtitle = document.getElementById('detailSubtitle');
    const detailImageContainer = document.getElementById('detailImageContainer');
    const detailMeta = document.getElementById('detailMeta');
    const detailIngredients = document.getElementById('detailIngredients');
    const detailRecipe = document.getElementById('detailRecipe');
    const detailMemo = document.getElementById('detailMemo');
    const backToListBtn = document.getElementById('backToListBtn');
    const detailProps = document.getElementById('detailProps');
    const propsSection = document.getElementById('propsSection');

    // â˜…â˜…â˜… ãƒ¬ã‚·ãƒ”ææ¡ˆæ©Ÿèƒ½ã®è¦ç´  â˜…â˜…â˜…
    const recommendOpenBtn = document.getElementById('recommendOpenBtn');
    const recommendContainer = document.getElementById('recommendContainer');
    const recommendOptions = document.getElementById('recommendOptions');
    const recommendResult = document.getElementById('recommendResult');

    let rawData = null;
    let flatList = []; // merged list with type annotation
    
    // ãƒ•ã‚£ãƒ«ã‚¿ã®çŠ¶æ…‹ã‚’ä¿æŒã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
    let activeFilters = {
        'fish-name': new Set(),
        difficulty: null,
        time: null,
        cost: null
    };
    // å›ºå®šã‚ªãƒ—ã‚·ãƒ§ãƒ³
    const DIFFICULTY_OPTIONS = ['1', '2', '3', '4', '5'];
    const TIME_OPTIONS = [15, 30, 60]; 
    const COST_OPTIONS = [500, 1000, 2000];
    const TIME_MAX = 120;
    const COST_MAX = 5000;
    const RECOMMEND_OPTIONS = [1, 3, 9];


    // Utility: safe text node creation
    function elText(tag, text, cls){
        const el = document.createElement(tag);
        if (cls) el.className = cls;
        el.textContent = (text === undefined || text === null) ? '' : String(text);
        return el;
    }

    // Try fetching from multiple paths in order
    async function fetchAny(paths){
        for (const p of paths){
            try {
                const res = await fetch(p, {cache: "no-store"});
                if (!res.ok) continue;
                const json = await res.json();
                return json;
            } catch(e){
                console.warn('fetch failed for', p, e);
            }
        }
        throw new Error('recipes.json ã‚’è¦‹ã¤ã‘ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚æœŸå¾…ã™ã‚‹å ´æ‰€: ' + paths.join(', '));
    }

    // Normalize and flatten recipes + preparations into an array for table
    function buildFlatList(data){
        const list = [];
        if (!data || typeof data !== 'object') return list;

        const recipes = data.recipes || {};
        for (const key of Object.keys(recipes)){
            const item = Object.assign({}, recipes[key]);
            item._type = 'recipe';
            item.No = item.No != null ? String(item.No) : String(key);
            item._origKey = key;
            list.push(item);
        }
        const pres = data.preparations || {};
        for (const key of Object.keys(pres)){
            const item = Object.assign({}, pres[key]);
            item._type = 'pre';
            item.No = item.No != null ? String(item.No) : String(key);
            item._origKey = key;
            list.push(item);
        }
        return list;
    }

    // safe join array-like fields for display
    function joinIfArray(val){
        if (Array.isArray(val)) return val.join(', ');
        if (val === undefined || val === null) return '';
        return String(val);
    }

    function clearTable(){ 
        if(tbody) tbody.innerHTML = ''; 
    }

    // --- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼UIæ§‹ç¯‰é–¢æ•° ---
    
    function createCheckboxGroup(title, key, values, hintText = '') {
        const fieldset = document.createElement('fieldset');
        fieldset.className = 'filter-group';
        const legend = document.createElement('legend');
        legend.textContent = title;
        fieldset.appendChild(legend);
        if (hintText) {
             const hint = elText('p', hintText, 'filter-hint');
             fieldset.appendChild(hint);
        }
        values.forEach(value => {
            const strValue = String(value);
            const id = `${key}-${strValue.replace(/[^a-zA-Z0-9]/g, '-')}`;
            const div = document.createElement('div');
            div.className = 'filter-item';
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = id;
            checkbox.value = strValue;
            checkbox.dataset.filterKey = key;
            if (activeFilters[key] && activeFilters[key].has(strValue)) {
                checkbox.checked = true;
            }
            const label = document.createElement('label');
            label.htmlFor = id;
            label.textContent = strValue;
            div.appendChild(checkbox);
            div.appendChild(label);
            fieldset.appendChild(div);
        });
        return fieldset;
    }

    function createRadioGroup(title, key, values, hintText = '', labels = null, type = 'radio', inputProps = {}) {
        const fieldset = document.createElement('fieldset');
        fieldset.className = 'filter-group';
        const legend = document.createElement('legend');
        legend.textContent = title;
        fieldset.appendChild(legend);
        if (hintText) {
             const hint = elText('p', hintText, 'filter-hint');
             fieldset.appendChild(hint);
        }
        
        const radioDiv = document.createElement('div');
        radioDiv.className = 'radio-options-container';

        // åˆ¶é™ãªã—
        const allRadioDiv = document.createElement('div');
        allRadioDiv.className = 'filter-item';
        const allId = `${key}-all`;
        const allRadio = document.createElement('input');
        allRadio.type = 'radio';
        allRadio.id = allId;
        allRadio.name = key;
        allRadio.value = '';
        allRadio.dataset.filterKey = key;
        if (activeFilters[key] === null || activeFilters[key] === '') {
            allRadio.checked = true;
        }
        const allLabel = document.createElement('label');
        allLabel.htmlFor = allId;
        allLabel.textContent = 'åˆ¶é™ãªã—';
        allRadioDiv.appendChild(allRadio);
        allRadioDiv.appendChild(allLabel);
        radioDiv.appendChild(allRadioDiv);

        // å®šç¾©æ¸ˆã¿ã®å€¤
        values.forEach((value, index) => {
            const strValue = String(value);
            const id = `${key}-${strValue}`;
            const labelText = labels ? labels[index] : strValue;
            const div = document.createElement('div');
            div.className = 'filter-item';
            const radio = document.createElement('input');
            radio.type = 'radio';
            radio.id = id;
            radio.name = key;
            radio.value = strValue;
            radio.dataset.filterKey = key;
            if (activeFilters[key] === strValue) {
                radio.checked = true;
            }
            const label = document.createElement('label');
            label.htmlFor = id;
            label.textContent = labelText;
            div.appendChild(radio);
            div.appendChild(label);
            radioDiv.appendChild(div);
        });
        
        let inputContainer = null;
        if (type === 'radio-input') {
            
            // ã‚«ã‚¹ã‚¿ãƒ ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
            const customRadioDiv = document.createElement('div');
            customRadioDiv.className = 'filter-item';
            const customId = `${key}-custom-radio`;
            const customRadio = document.createElement('input');
            customRadio.type = 'radio';
            customRadio.id = customId;
            customRadio.name = key;
            customRadio.value = 'CUSTOM';
            customRadio.dataset.filterKey = key;
            
            const isCustomSelected = activeFilters[key] !== null && activeFilters[key] !== '' && !values.map(String).includes(activeFilters[key]);
            if (isCustomSelected) {
                customRadio.checked = true;
            }
            
            const customLabel = document.createElement('label');
            customLabel.htmlFor = customId;
            customLabel.textContent = 'ã‚«ã‚¹ã‚¿ãƒ å€¤ã‚’å…¥åŠ›';
            customRadioDiv.appendChild(customRadio);
            customRadioDiv.appendChild(customLabel);
            radioDiv.appendChild(customRadioDiv);
            
            fieldset.appendChild(radioDiv);
            

            // ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
            inputContainer = document.createElement('div');
            inputContainer.className = 'filter-input-container';
            inputContainer.style.marginTop = '10px';
            inputContainer.style.borderTop = '1px dashed #e2e8f0';
            inputContainer.style.paddingTop = '10px';
            if (!isCustomSelected) {
                inputContainer.style.display = 'none';
            }

            const inputId = `${key}-custom-input`;
            const labelText = (key === 'time') ? 'åˆ†' : 'å††';

            const input = document.createElement('input');
            input.type = 'number';
            input.id = inputId;
            input.name = `${key}-custom`;
            input.placeholder = `æœ€å¤§å€¤ (${inputProps.max})`;
            input.min = inputProps.min || 1;
            input.max = inputProps.max || 9999;
            input.style.width = '120px';
            input.style.padding = '6px 10px';
            input.style.borderRadius = '6px';
            input.style.border = '1px solid #d6d8df';
            input.dataset.filterKey = key;
            input.dataset.inputType = 'custom';

            if (isCustomSelected) {
                input.value = activeFilters[key];
            }
            
            const label = document.createElement('label');
            label.htmlFor = inputId;
            label.textContent = `ä»¥ä¸‹ã®æœ€å¤§å€¤ã‚’è¨­å®š (${labelText}ä»¥ä¸‹): `;
            label.style.fontWeight = 'normal';
            label.style.marginRight = '5px';

            inputContainer.appendChild(label);
            inputContainer.appendChild(input);
            fieldset.appendChild(inputContainer);
        } else {
            fieldset.appendChild(radioDiv);
        }

        return fieldset;
    }


    function setupFilterModal(list){
        if (!filterContent) return; 
        filterContent.innerHTML = '';
        const fragment = document.createDocumentFragment();

        // é­šç¨®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        const fishSet = new Set();
        list.forEach(item => {
            if (Array.isArray(item['fish-name'])) {
                item['fish-name'].forEach(fish => {
                    const trimmedFish = fish.trim();
                    if (trimmedFish) fishSet.add(trimmedFish);
                });
            }
        });
        const uniqueFish = Array.from(fishSet).sort();
        fragment.appendChild(createCheckboxGroup('é­šç¨®', 'fish-name', uniqueFish, 'ãƒ¬ã‚·ãƒ”/ä¸‹å‡¦ç†ã«ä½¿ã†é­šãŒã€é¸æŠã—ãŸé­šç¨®ã®ã™ã¹ã¦ã«å«ã¾ã‚Œã‚‹ã‚‚ã®ã‚’è¡¨ç¤º (b âŠ† a)'));

        // é›£æ˜“åº¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        fragment.appendChild(createRadioGroup('é›£æ˜“åº¦ (æœ€å¤§)', 'difficulty', DIFFICULTY_OPTIONS, 'é¸æŠã—ãŸé›£æ˜“åº¦ä»¥ä¸‹ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¡¨ç¤º', DIFFICULTY_OPTIONS.map(d => `é›£æ˜“åº¦ ${d} ä»¥ä¸‹`)));

        // æ‰€è¦æ™‚é–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        fragment.appendChild(createRadioGroup('æ‰€è¦æ™‚é–“ (åˆ†ãƒ»æœ€å¤§)', 'time', TIME_OPTIONS, 'é¸æŠè‚¢ã¾ãŸã¯ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›ã§æŒ‡å®šã—ãŸæ™‚é–“ä»¥ä¸‹ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¡¨ç¤º', TIME_OPTIONS.map(t => `${t}åˆ†ä»¥å†…`), 'radio-input', {min: 1, max: TIME_MAX}));

        // è²»ç”¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        fragment.appendChild(createRadioGroup('è²»ç”¨ (å††ãƒ»æœ€å¤§)', 'cost', COST_OPTIONS, 'é¸æŠè‚¢ã¾ãŸã¯ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›ã§æŒ‡å®šã—ãŸè²»ç”¨ä»¥ä¸‹ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¡¨ç¤º', COST_OPTIONS.map(c => `Â¥${c}ä»¥ä¸‹`), 'radio-input', {min: 100, max: COST_MAX}));

        filterContent.appendChild(fragment);

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®å†è¨­å®š
        filterContent.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', updateActiveFilters);
        });
        filterContent.querySelectorAll('input[type="radio"], input[type="number"]').forEach(input => {
            input.addEventListener('change', handleRadioInputChange);
            input.addEventListener('input', handleRadioInputChange);
        });
    }

    function handleRadioInputChange(event) {
        const input = event.target;
        const key = input.dataset.filterKey;

        if (key === 'time' || key === 'cost') {
            const customContainer = filterContent.querySelector(`.filter-input-container input[data-filter-key="${key}"]`).parentNode;

            if (input.type === 'radio') {
                if (input.value === 'CUSTOM') {
                    customContainer.style.display = 'block';
                } else {
                    customContainer.style.display = 'none';
                    customContainer.querySelector('input[type="number"]').value = '';
                }
            }
        }
        
        updateActiveFilters();
    }


    function updateActiveFilters() {
        // fish-name ã¯ Setã‚’å†æ§‹ç¯‰
        activeFilters['fish-name'].clear();
        filterContent.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
            if (checkbox.dataset.filterKey === 'fish-name') {
                activeFilters['fish-name'].add(checkbox.value);
            }
        });
        
        // difficulty, time, cost ã¯å˜ä¸€ã®å€¤ã‚’è¨­å®š
        ['difficulty', 'time', 'cost'].forEach(key => {
            activeFilters[key] = null;

            const checkedRadio = filterContent.querySelector(`input[type="radio"][name="${key}"]:checked`);
            if (checkedRadio) {
                if (checkedRadio.value === '') {
                    activeFilters[key] = null;
                } else if (checkedRadio.value === 'CUSTOM') {
                    const customInput = filterContent.querySelector(`input[type="number"][data-filter-key="${key}"][data-input-type="custom"]`);
                    const val = parseFloat(customInput.value);
                    if (!isNaN(val) && val > 0) {
                        activeFilters[key] = String(val);
                    }
                } else {
                    activeFilters[key] = checkedRadio.value;
                }
            }
        });
    }
    
    // --- ãƒ†ãƒ¼ãƒ–ãƒ«æç”»ã¨è©³ç´°è¡¨ç¤ºé–¢æ•° ---
    function renderTable(list){
        clearTable();
        if (!tbody) return; 

        if (!Array.isArray(list) || list.length === 0){
            tbody.innerHTML = '<tr><td colspan="8" class="muted" style="padding:20px;text-align:center">è¡¨ç¤ºã™ã‚‹ãƒ¬ã‚·ãƒ”ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>';
            return;
        }
        const fragment = document.createDocumentFragment();
        for (const item of list){
            const tr = document.createElement('tr');

            // No
            const tdNo = document.createElement('td');
            tdNo.textContent = item.No || '-';
            tr.appendChild(tdNo);

            // Type
            const tdType = document.createElement('td');
            const span = document.createElement('span');
            span.className = 'tag-type ' + (item._type === 'pre' ? 'type-pre' : 'type-recipe');
            span.textContent = item._type;
            tdType.appendChild(span);
            tr.appendChild(tdType);

            // Picture
            const tdPicture = document.createElement('td');
            const img = document.createElement('img');
            img.className = 'recipe-thumb';
            const firstPic = (Array.isArray(item.pictures) && item.pictures.length > 0) ? item.pictures[0] : null;
            let imgSrc = firstPic && typeof firstPic === 'string' ? firstPic : 'https://0128-game.github.io/Fish-recipe/picture/noimage.png';
            img.src = imgSrc;
            img.alt = item.title || 'ç”»åƒ';
            tdPicture.appendChild(img);
            tr.appendChild(tdPicture);

            // Title and flavortxt
            const tdTitle = document.createElement('td');
            const title = elText('div', item.title || '(ã‚¿ã‚¤ãƒˆãƒ«ãªã—)', ''); title.style.fontWeight='700';
            const flav = elText('div', item.flavortxt || '', 'muted');
            tdTitle.appendChild(title);
            tdTitle.appendChild(flav);
            tr.appendChild(tdTitle);

            // fish / season
            const tdFish = document.createElement('td');
            tdFish.appendChild(elText('div', joinIfArray(item['fish-name']) || '-', ''));
            tdFish.appendChild(elText('div', joinIfArray(item.season) || '', 'muted'));
            tr.appendChild(tdFish);

            // difficulty / time
            const tdDiff = document.createElement('td');
            tdDiff.appendChild(elText('div', 'é›£æ˜“åº¦: ' + (item.difficulty != null ? item.difficulty : '-')));
            tdDiff.appendChild(elText('div', 'æ‰€è¦: ' + (item.time != null ? item.time + 'åˆ†' : '-'), 'muted'));
            tr.appendChild(tdDiff);

            // cost / info line
            const tdCost = document.createElement('td');
            tdCost.appendChild(elText('div', 'Â¥' + (item.cost != null ? item.cost : '-')));
            const infoLine = (item._type === 'recipe')
                ? ('é£Ÿäº‹: ' + (item.timing || '-'))
                : ('ç‰¹å¾´: ' + joinIfArray(item.feature));
            tdCost.appendChild(elText('div', infoLine, 'muted'));
            tr.appendChild(tdCost);

            // actions
            const tdActions = document.createElement('td');
            tdActions.className = 'actions';

            // è©³ç´°ãƒœã‚¿ãƒ³
            const viewBtn = document.createElement('button');
            viewBtn.textContent = 'è©³ç´°';
            viewBtn.addEventListener('click', ()=> {
                displayDetail(item);
            });
            tdActions.appendChild(viewBtn);

            // å°åˆ·ãƒœã‚¿ãƒ³
            const printBtn = document.createElement('button');
            printBtn.textContent = 'å°åˆ·';
            printBtn.style.background = '#a0aec0'; 
            printBtn.addEventListener('click', ()=> {
                displayDetail(item);
                setTimeout(() => {
                    window.print();
                }, 500); 
            });
            tdActions.appendChild(printBtn);

            tr.appendChild(tdActions);
            fragment.appendChild(tr);
        }
        tbody.appendChild(fragment);
    }
    
    function createPictureElement(src, altText, maxHeight = '250px') {
        if (!src || src === 'null' || src === '') return null;
        const img = document.createElement('img');
        img.src = src;
        img.alt = altText || 'ç”»åƒ';
        img.style.maxWidth = '100%';
        img.style.maxHeight = maxHeight;
        img.style.width = 'auto';
        img.style.objectFit = 'contain';
        img.style.borderRadius = '4px';
        img.style.display = 'block';
        img.style.margin = '0 auto';
        return img;
    }

    function displayDetail(item){
        if(!detailTitle || !detailSubtitle || !detailMeta || !detailImageContainer || !detailIngredients || !detailRecipe || !detailMemo || !propsSection) {
            console.error("Missing detail element(s) in HTML.");
            return;
        }

        if (wrap) {
            wrap.classList.remove('list-view');
            wrap.classList.add('detail-view');
            wrap.classList.remove('recommend-view');
        }
        window.scrollTo({ top: 0, behavior: 'smooth' });

        const pictures = item.pictures || [];
        const thumbPic = pictures[0] || 'https://0128-game.github.io/Fish-recipe/picture/noimage.png';

        detailTitle.textContent = (item.title || '(ã‚¿ã‚¤ãƒˆãƒ«ãªã—)') + ' â€” No.' + item.No;
        detailSubtitle.textContent = item.flavortxt || '';

        detailMeta.innerHTML = '';
        detailMeta.appendChild(elText('div', 'ã‚¿ã‚¤ãƒ—: ' + (item._type || '-'), 'pill'));
        detailMeta.appendChild(elText('div', 'é­š: ' + joinIfArray(item['fish-name']) , 'pill'));
        detailMeta.appendChild(elText('div', 'æ—¬: ' + joinIfArray(item.season), 'pill'));
        detailMeta.appendChild(elText('div', 'é›£æ˜“åº¦: ' + (item.difficulty != null ? item.difficulty : '-'), 'pill'));
        detailMeta.appendChild(elText('div', 'è²»ç”¨: ' + (item.cost != null ? 'Â¥' + item.cost : '-'), 'pill'));
        detailMeta.appendChild(elText('div', 'æ‰€è¦æ™‚é–“: ' + (item.time != null ? item.time + 'åˆ†' : '-'), 'pill'));

        if (item._type === 'recipe') {
            const preRecipeNo = item['pre-recipe'] ? String(item['pre-recipe']) : null;

            if (preRecipeNo) {
                const preItem = flatList.find(i => i._type === 'pre' && String(i.No) === preRecipeNo);

                if (preItem) {
                    const preBtn = document.createElement('button');
                    preBtn.textContent = 'ä¸‹å‡¦ç†: ' + (preItem.title || preItem.No); 
                    preBtn.className = 'pill pre-link-pill';
                    preBtn.style.cursor = 'pointer'; 
                    preBtn.addEventListener('click', ()=> displayDetail(preItem)); 
                    detailMeta.appendChild(preBtn);
                } else {
                    detailMeta.appendChild(elText('div', 'ä¸‹å‡¦ç†: No.' + preRecipeNo + ' (æœªç™ºè¦‹)', 'pill'));
                }
            } else {
                 detailMeta.appendChild(elText('div', 'ä¸‹å‡¦ç†: ãªã—', 'pill'));
            }
        } else if (item._type === 'pre') {
             detailMeta.appendChild(elText('div', 'ä¸‹å‡¦ç†', 'pill'));
        }

        detailImageContainer.innerHTML = '';
        const mainImg = createPictureElement(thumbPic, item.title, '250px');
        if (mainImg) {
            mainImg.style.border = '1px solid #ddd';
            mainImg.style.borderRadius = '8px';
            detailImageContainer.appendChild(mainImg);
        }

        detailIngredients.innerHTML = '';
        const ing = item.ingredients || {};

        if (Object.keys(ing).length === 0){
            detailIngredients.appendChild(elText('div','(ææ–™ãªã—)','muted'));
        } else {
            const ul = document.createElement('ul');
            for (const k of Object.keys(ing)){
                const li = document.createElement('li');
                li.textContent = k + ': ' + (ing[k] || '');
                ul.appendChild(li);
            }
            detailIngredients.appendChild(ul);
        }

        detailProps.innerHTML = '';
        const props = item.props || {};

        if (item._type === 'pre') {
            if (propsSection) propsSection.style.display = 'block';

            if (Object.keys(props).length === 0){
                detailProps.appendChild(elText('div', '(é“å…·ãªã—)', 'muted'));
            } else {
                const ul = document.createElement('ul');
                for (const k of Object.keys(props)){
                    const li = document.createElement('li');
                    li.textContent = props[k] || '';
                    ul.appendChild(li);
                }
                detailProps.appendChild(ul);
            }
        } else {
            if (propsSection) propsSection.style.display = 'none';
        }

        detailRecipe.innerHTML = '';
        const rec = item.recipe || [];

        if (!Array.isArray(rec) || rec.length === 0){
            detailRecipe.appendChild(elText('div','(æ‰‹é †ãªã—)','muted'));
        } else {
            const gridContainer = document.createElement('div');
            gridContainer.style.display = 'grid';
            gridContainer.style.gridTemplateColumns = 'repeat(auto-fit, minmax(280px, 1fr))';
            gridContainer.style.gap = '10px';
            
            for (let i = 0; i < rec.length; i++){
                const step = rec[i];
                const stepNo = i + 1;

                const card = document.createElement('div');
                card.className = 'recipe-step-card'; 
                card.style.border = '1px solid #dee2e6'; 
                card.style.padding = '15px';
                card.style.borderRadius = '6px';
                card.style.background = 'var(--card)';
                card.style.boxShadow = '0 1px 3px rgba(0,0,0,0.05)';

                const stepPicIndex = i + 1;
                const stepPicSrc = pictures[stepPicIndex];

                if (stepPicSrc && stepPicSrc !== 'null' && stepPicSrc !== '') {
                    const picContainer = document.createElement('div');
                    picContainer.className = 'recipe-step-picture';
                    const stepImg = createPictureElement(stepPicSrc, `æ‰‹é †${stepNo}ã®ç”»åƒ`, '150px');

                    if (stepImg) {
                        picContainer.appendChild(stepImg);
                        card.appendChild(picContainer);
                    }
                }

                const p = document.createElement('p');
                p.innerHTML = `<span style="font-weight:bold; color:var(--accent);">${stepNo}.</span> ${step}`;
                card.appendChild(p);

                gridContainer.appendChild(card);
            }
            
            detailRecipe.appendChild(gridContainer);
        }

        detailMemo.innerHTML = '';
        const memo = item.memo || [];
        if (!Array.isArray(memo) || memo.length === 0){
            detailMemo.appendChild(elText('div','(ãƒ¡ãƒ¢ãªã—)','muted'));
        } else {
            const ulm = document.createElement('ul');
            for (const m of memo){
                ulm.appendChild(elText('li', m));
            }
            detailMemo.appendChild(ulm);
        }
    }
    // --- ãƒ†ãƒ¼ãƒ–ãƒ«æç”»ã¨è©³ç´°è¡¨ç¤ºé–¢æ•° ã“ã“ã¾ã§ ---


    // --- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨ã¨æç”» ---
    function applyFiltersAndRender(){
        if(!qInput || !filterType || !sortBy || !message) { return; }

        const q = (qInput.value || '').trim().toLowerCase();
        const type = filterType.value;
        const sortVal = sortBy.value;

        let list = flatList.slice();

        // 1. ã‚¿ã‚¤ãƒ—ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        if (type !== 'all') list = list.filter(i => i._type === type);

        // 2. æ¤œç´¢ (Search)
        if (q){
            list = list.filter(item => {
                const parts = [
                    item.title, item.flavortxt,
                    joinIfArray(item['fish-name']),
                    joinIfArray(item.feature),
                    joinIfArray(item.season),
                    item.No,
                    Object.keys(item.ingredients || {}).join(' '),
                    joinIfArray(item.recipe),
                    joinIfArray(item.memo),
                    joinIfArray(item.props)
                ];
                const hay = parts.filter(Boolean).join(' ').toLowerCase();
                return hay.includes(q);
            });
        }

        // 3. ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ­ã‚¸ãƒƒã‚¯ã®é©ç”¨ 
        list = list.filter(item => {
            // é­šç¨®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ (fish-name) - ANDæ¡ä»¶ (b âŠ† a)
            const activeFish = activeFilters['fish-name'];
            if (activeFish.size > 0) {
                const itemFish = Array.isArray(item['fish-name']) ? item['fish-name'].map(f => f.trim()) : [];
                if (!itemFish.every(f => activeFish.has(f))) return false;
            }

            // é›£æ˜“åº¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ (difficulty) - æœ€å¤§å€¤æ¡ä»¶
            const maxDiff = activeFilters.difficulty ? parseFloat(activeFilters.difficulty) : null;
            if (maxDiff !== null && item.difficulty != null) {
                const itemDiff = parseFloat(item.difficulty);
                if (!isNaN(itemDiff) && itemDiff > maxDiff) return false;
            }

            // æ‰€è¦æ™‚é–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ (time) - æœ€å¤§å€¤æ¡ä»¶
            const maxTime = activeFilters.time ? parseFloat(activeFilters.time) : null;
            if (maxTime !== null && item.time != null) {
                const itemTime = parseFloat(item.time);
                if (!isNaN(itemTime) && itemTime > maxTime) return false;
            }
            
            // è²»ç”¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ (cost) - æœ€å¤§å€¤æ¡ä»¶
            const maxCost = activeFilters.cost ? parseFloat(activeFilters.cost) : null;
            if (maxCost !== null && item.cost != null) {
                const itemCost = parseFloat(item.cost);
                if (!isNaN(itemCost) && itemCost > maxCost) return false;
            }

            return true;
        });


        // 4. ã‚½ãƒ¼ãƒˆ (Sort)
        const desc = sortVal.startsWith('-');
        const key = desc ? sortVal.slice(1) : sortVal;

        list.sort((a,b)=>{
            const av = a[key];
            const bv = b[key];

            if (key === 'No'){
                const extractNum = (val) => {
                    const s = String(val||'');
                    const isPre = s.startsWith('P');
                    const num = parseInt(s.replace(/^P/,'') || '0', 10);
                    return isPre ? num + 0.5 : num;
                };
                const na = extractNum(av);
                const nb = extractNum(bv);
                return desc ? nb - na : na - nb;
            }

            const an = (av == null) ? Number.POSITIVE_INFINITY : Number(av);
            const bn = (bv == null) ? Number.POSITIVE_INFINITY : Number(bv);
            if (!isFinite(an) || !isFinite(bn)){
                return desc ? String(bv).localeCompare(String(av)) : String(av).localeCompare(String(bv));
            }
            return desc ? bn - an : an - bn;
        });


        renderTable(list);
        
        let activeCount = activeFilters['fish-name'].size;
        ['difficulty', 'time', 'cost'].forEach(key => {
            if (activeFilters[key] !== null) activeCount++;
        });

        let filterText = '';
        if (activeCount > 0) {
             filterText = ` (${activeCount} ç¨®é¡ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨ä¸­)`;
        }

        message.textContent = `${list.length} ä»¶ã®çµæœã‚’è¡¨ç¤ºä¸­ (å…¨ ${flatList.length} ä»¶)${filterText}`;
    }
    // --- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨ã¨æç”» ã“ã“ã¾ã§ ---


    // --- ãŠã™ã™ã‚ãƒ¬ã‚·ãƒ”ææ¡ˆæ©Ÿèƒ½ã®ãƒ­ã‚¸ãƒƒã‚¯ ---

    function setupRecommendOptions() {
        if (!recommendOptions) return;
        
        recommendOptions.innerHTML = '';
        recommendResult.innerHTML = '';
        
        const key = 'recommend-count';
        const title = 'ææ¡ˆã™ã‚‹ãƒ¬ã‚·ãƒ”ã®é£Ÿæ•°';
        const values = RECOMMEND_OPTIONS;
        
        // --- 1. ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚µãƒãƒªãƒ¼ã¨ãƒœã‚¿ãƒ³ã®è¿½åŠ  ---
        const filterButtonContainer = document.createElement('div');
        filterButtonContainer.style.marginBottom = '20px';
        filterButtonContainer.style.paddingBottom = '15px';
        filterButtonContainer.style.borderBottom = '1px solid #e2e8f0';

        const filterSummaryBtn = document.createElement('button');
        filterSummaryBtn.id = 'recommendFilterSummaryBtn';
        filterSummaryBtn.style.padding = '8px 15px';
        filterSummaryBtn.style.borderRadius = '6px';
        filterSummaryBtn.style.backgroundColor = '#f7fafc';
        filterSummaryBtn.style.border = '1px solid #cbd5e0';
        filterSummaryBtn.style.cursor = 'pointer';
        filterSummaryBtn.style.color = '#4a5568';
        filterSummaryBtn.style.fontWeight = 'bold';
        
        let activeCount = activeFilters['fish-name'].size;
        ['difficulty', 'time', 'cost'].forEach(key => {
            if (activeFilters[key] !== null) activeCount++;
        });

        filterSummaryBtn.textContent = `âš™ï¸ ç¾åœ¨ã®çµã‚Šè¾¼ã¿è¨­å®šã‚’ç¢ºèªãƒ»å¤‰æ›´ (${activeCount} ç¨®é¡é©ç”¨ä¸­)`;
        
        filterSummaryBtn.addEventListener('click', () => {
             setupFilterModal(flatList); 
             if (filterModal) filterModal.style.display = 'flex';
        });

        filterButtonContainer.appendChild(filterSummaryBtn);
        recommendOptions.appendChild(filterButtonContainer);
        // --------------------------------------------------------

        const fieldset = document.createElement('fieldset');
        fieldset.className = 'filter-group recommend-options-group';
        fieldset.style.border = 'none';
        
        const legend = elText('legend', title);
        legend.style.fontWeight = 'bold';
        fieldset.appendChild(legend);

        const radioDiv = document.createElement('div');
        radioDiv.className = 'radio-options-container';
        radioDiv.style.display = 'flex';
        radioDiv.style.gap = '10px';

        // å®šç¾©æ¸ˆã¿ã®å€¤ (1, 3, 9é£Ÿ)
        values.forEach((value, index) => {
            const strValue = String(value);
            const id = `${key}-${strValue}`;

            const div = document.createElement('div');
            div.className = 'filter-item';

            const radio = document.createElement('input');
            radio.type = 'radio';
            radio.id = id;
            radio.name = key;
            radio.value = strValue;
            
            if (value === 3) radio.checked = true;

            const label = document.createElement('label');
            label.htmlFor = id;
            label.textContent = `${strValue}é£Ÿ`;

            div.appendChild(radio);
            div.appendChild(label);
            radioDiv.appendChild(div);
        });

        // ã‚«ã‚¹ã‚¿ãƒ ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
        const customRadioDiv = document.createElement('div');
        customRadioDiv.className = 'filter-item';
        const customId = `${key}-custom-radio`;
        const customRadio = document.createElement('input');
        customRadio.type = 'radio';
        customRadio.id = customId;
        customRadio.name = key;
        customRadio.value = 'CUSTOM';
        
        const customLabel = document.createElement('label');
        customLabel.htmlFor = customId;
        customLabel.textContent = 'ã‚«ã‚¹ã‚¿ãƒ é£Ÿæ•°';
        customRadioDiv.appendChild(customRadio);
        customRadioDiv.appendChild(customLabel);
        radioDiv.appendChild(customRadioDiv);
        
        fieldset.appendChild(radioDiv);
        
        // ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
        const inputContainer = document.createElement('div');
        inputContainer.className = 'recommend-input-container';
        inputContainer.style.marginTop = '10px';
        inputContainer.style.padding = '10px 0';

        const inputId = `${key}-custom-input`;
        const input = document.createElement('input');
        input.type = 'number';
        input.id = inputId;
        input.name = `${key}-custom`;
        input.placeholder = `é£Ÿæ•°ã‚’å…¥åŠ› (æœ€å¤§${flatList.filter(i => i._type === 'recipe').length})`;
        input.min = 1;
        input.max = flatList.filter(i => i._type === 'recipe').length || 100;
        input.style.width = '150px';
        input.style.padding = '6px 10px';
        input.style.borderRadius = '6px';
        input.style.border = '1px solid #d6d8df';
        
        const label = document.createElement('label');
        label.htmlFor = inputId;
        label.textContent = `ææ¡ˆã™ã‚‹é£Ÿæ•°: `;
        label.style.fontWeight = 'normal';
        label.style.marginRight = '5px';

        inputContainer.appendChild(label);
        inputContainer.appendChild(input);
        
        inputContainer.style.display = 'none';

        // ææ¡ˆãƒœã‚¿ãƒ³
        const generateBtn = document.createElement('button');
        generateBtn.textContent = 'ææ¡ˆã‚’ç”Ÿæˆ';
        generateBtn.style.marginTop = '15px';
        generateBtn.style.padding = '10px 20px';
        generateBtn.style.backgroundColor = 'var(--accent)';
        generateBtn.style.color = 'white';
        generateBtn.style.border = 'none';
        generateBtn.style.borderRadius = '6px';
        generateBtn.style.cursor = 'pointer';
        generateBtn.addEventListener('click', generateAndRenderRecommendations);

        
        recommendOptions.appendChild(fieldset);
        recommendOptions.appendChild(inputContainer);
        recommendOptions.appendChild(generateBtn);

        // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®åˆ‡ã‚Šæ›¿ãˆã‚¤ãƒ™ãƒ³ãƒˆ
        radioDiv.querySelectorAll('input[type="radio"]').forEach(radio => {
            radio.addEventListener('change', () => {
                if (radio.value === 'CUSTOM') {
                    inputContainer.style.display = 'block';
                } else {
                    inputContainer.style.display = 'none';
                }
            });
        });
    }


    function generateAndRenderRecommendations() {
        if (!recommendResult || !recommendOptions) return;
        
        recommendResult.innerHTML = '';
        
        // 1. å¿…è¦ãªé£Ÿæ•°ã‚’å–å¾—
        let count = 0;
        const checkedRadio = recommendOptions.querySelector('input[name="recommend-count"]:checked');
        
        if (checkedRadio) {
            if (checkedRadio.value === 'CUSTOM') {
                const customInput = recommendOptions.querySelector('input[name="recommend-count-custom"]');
                count = parseInt(customInput.value, 10);
            } else {
                count = parseInt(checkedRadio.value, 10);
            }
        }
        
        if (isNaN(count) || count <= 0) {
            recommendResult.appendChild(elText('p', 'æœ‰åŠ¹ãªé£Ÿæ•°ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚', 'notice'));
            return;
        }

        // 2. ãƒ¬ã‚·ãƒ”ã‚¢ã‚¤ãƒ†ãƒ ã®ã¿ã‚’æŠ½å‡ºã—ã€æ—¢å­˜ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨
        let potentialRecipes = flatList.filter(item => item._type === 'recipe');
        
        potentialRecipes = potentialRecipes.filter(item => {
            const activeFish = activeFilters['fish-name'];
            if (activeFish.size > 0) {
                const itemFish = Array.isArray(item['fish-name']) ? item['fish-name'].map(f => f.trim()) : [];
                if (!itemFish.every(f => activeFish.has(f))) return false;
            }

            const maxDiff = activeFilters.difficulty ? parseFloat(activeFilters.difficulty) : null;
            if (maxDiff !== null && item.difficulty != null) {
                const itemDiff = parseFloat(item.difficulty);
                if (!isNaN(itemDiff) && itemDiff > maxDiff) return false;
            }

            const maxTime = activeFilters.time ? parseFloat(activeFilters.time) : null;
            if (maxTime !== null && item.time != null) {
                const itemTime = parseFloat(parseFloat(item.time));
                if (!isNaN(itemTime) && itemTime > maxTime) return false;
            }
            
            const maxCost = activeFilters.cost ? parseFloat(activeFilters.cost) : null;
            if (maxCost !== null && item.cost != null) {
                const itemCost = parseFloat(item.cost);
                if (!isNaN(itemCost) && itemCost > maxCost) return false;
            }

            return true;
        });
        
        const availableCount = potentialRecipes.length;

        if (availableCount === 0) {
            recommendResult.appendChild(elText('p', 'ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®šã§ã¯ææ¡ˆã§ãã‚‹ãƒ¬ã‚·ãƒ”ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’èª¿æ•´ã—ã¦ãã ã•ã„ã€‚', 'notice'));
            return;
        }

        if (count > availableCount) {
            recommendResult.appendChild(elText('p', `ãƒªã‚¯ã‚¨ã‚¹ãƒˆã•ã‚ŒãŸ${count}é£Ÿã«å¯¾ã—ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã«åˆè‡´ã™ã‚‹ãƒ¬ã‚·ãƒ”ã¯${availableCount}ä»¶ã—ã‹ã‚ã‚Šã¾ã›ã‚“ã€‚${availableCount}ä»¶ã®ãƒ¬ã‚·ãƒ”ã‚’ææ¡ˆã—ã¾ã™ã€‚`, 'warning'));
            count = availableCount;
        }


        // 3. ãƒ©ãƒ³ãƒ€ãƒ ã«ãƒ¬ã‚·ãƒ”ã‚’é¸æŠ
        for (let i = potentialRecipes.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [potentialRecipes[i], potentialRecipes[j]] = [potentialRecipes[j], potentialRecipes[i]];
        }
        
        const recommendedList = potentialRecipes.slice(0, count);

        // 4. çµæœã‚’è¡¨ç¤º
        const resultHeader = elText('h3', `ğŸ‰ ãŠã™ã™ã‚ãƒ¬ã‚·ãƒ” ${count}é£Ÿåˆ†ã®ææ¡ˆ`);
        recommendResult.appendChild(resultHeader);
        
        const listContainer = document.createElement('div');
        listContainer.className = 'recommend-list';
        listContainer.style.display = 'grid';
        listContainer.style.gridTemplateColumns = 'repeat(auto-fit, minmax(300px, 1fr))';
        listContainer.style.gap = '20px';
        listContainer.style.marginTop = '20px';
        
        recommendedList.forEach((item, index) => {
            const card = document.createElement('div');
            card.className = 'recommend-card';
            card.style.border = '1px solid #ddd';
            card.style.padding = '15px';
            card.style.borderRadius = '8px';
            card.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';
            card.style.cursor = 'pointer';
            card.addEventListener('click', () => displayDetail(item));

            const img = createPictureElement(
                (Array.isArray(item.pictures) && item.pictures.length > 0) ? item.pictures[0] : 'https://0128-game.github.io/Fish-recipe/picture/noimage.png',
                item.title,
                '150px'
            );
            if (img) {
                img.style.marginBottom = '10px';
                card.appendChild(img);
            }
            
            card.appendChild(elText('h4', `No.${item.No}: ${item.title}`, ''));
            card.appendChild(elText('p', item.flavortxt || '', 'muted'));
            card.appendChild(elText('div', 'é­šç¨®: ' + joinIfArray(item['fish-name']), ''));
            card.appendChild(elText('div', 'é›£æ˜“åº¦: ' + (item.difficulty || '-'), ''));
            
            listContainer.appendChild(card);
        });

        recommendResult.appendChild(listContainer);
    }

    function openRecommendScreen() {
        if (!wrap) return;
        
        wrap.classList.remove('list-view');
        wrap.classList.remove('detail-view');
        wrap.classList.add('recommend-view');
        window.scrollTo({ top: 0, behavior: 'smooth' });

        setupRecommendOptions();
        generateAndRenderRecommendations();
    }
    
    function backToListFromRecommend() {
        if (!wrap) return;
        
        wrap.classList.remove('recommend-view');
        wrap.classList.remove('detail-view');
        wrap.classList.add('list-view');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    // --- ãŠã™ã™ã‚ãƒ¬ã‚·ãƒ”ææ¡ˆæ©Ÿèƒ½ã®ãƒ­ã‚¸ãƒƒã‚¯ ã“ã“ã¾ã§ ---


    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
    if(reloadBtn) reloadBtn.addEventListener('click', ()=> loadData());
    if(backToListBtn) backToListBtn.addEventListener('click', ()=> {
        if(wrap) {
            wrap.classList.remove('detail-view');
            wrap.classList.remove('recommend-view');
            wrap.classList.add('list-view');
        }
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    if (backToRecommendBtn) backToRecommendBtn.addEventListener('click', backToListFromRecommend);
    
    if(qInput) qInput.addEventListener('input', ()=> applyFiltersAndRender());
    if(filterType) filterType.addEventListener('change', ()=> applyFiltersAndRender());
    if(sortBy) sortBy.addEventListener('change', ()=> applyFiltersAndRender());
    
    if (recommendOpenBtn) recommendOpenBtn.addEventListener('click', openRecommendScreen);
    
    if (filterOpenBtn) {
        filterOpenBtn.addEventListener('click', () => {
             setupFilterModal(flatList); 
             if (filterModal) filterModal.style.display = 'flex';
        });
        
        if (filterModal) {
            filterModal.addEventListener('click', (e) => {
                if (e.target === filterModal) {
                    filterModal.style.display = 'none';
                }
            });
        }
    }

    if (applyFilterBtn) {
        applyFilterBtn.addEventListener('click', () => {
             updateActiveFilters();
             applyFiltersAndRender();
             if (filterModal) filterModal.style.display = 'none';
        });
    }
    
    if (filterClearBtn) {
        filterClearBtn.addEventListener('click', () => {
             activeFilters = {
                'fish-name': new Set(),
                difficulty: null,
                time: null,
                cost: null
             };
             setupFilterModal(flatList); 
             applyFiltersAndRender();
        });
    }
    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ã“ã“ã¾ã§ ---


    // main loader
    async function loadData(){
        if(message) message.textContent = 'èª­ã¿è¾¼ã¿ä¸­...';
        try {
            const json = await fetchAny(tryPaths);
            rawData = json;
            flatList = buildFlatList(json);

            if (flatList.length === 0){
                if(message) message.innerHTML = '<div class="notice">recipes ã¾ãŸã¯ preparations ã®ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™ã€‚docs/recipes.json ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>';
            } else {
                if(message) message.textContent = `èª­ã¿è¾¼ã¿å®Œäº† â€” åˆè¨ˆ ${flatList.length} ä»¶ï¼ˆrecipes: ${Object.keys(json.recipes||{}).length}, preparations: ${Object.keys(json.preparations||{}).length}ï¼‰`;
            }
            
            applyFiltersAndRender();
            if(wrap) {
                 wrap.classList.remove('detail-view');
                 wrap.classList.remove('recommend-view');
                 wrap.classList.add('list-view');
            }
        } catch (err){
            console.error(err);
            if(message) message.innerHTML = '<div class="notice">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + String(err.message) + '</div>';
            clearTable();
            if(wrap) wrap.classList.remove('detail-view');
        }
    }

    // initial load
    loadData();

    // Expose for debug on window
    window._recipesApp = {
        loadData,
        getRaw: ()=> rawData,
        getFlat: ()=> flatList,
        activeFilters: activeFilters,
        openRecommendScreen,
    };
})();
</script>
</body>
</html>
