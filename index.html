<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>魚料理レシピ一覧</title>
<style>
:root{
  --bg:#f6f7fb;
  --card:#ffffff;
  --accent:#2b6cb0;
  --muted:#666;
  --success:#2f855a;
  --danger:#c53030;
  --max-width:1200px;
}
*{box-sizing:border-box}
body{
  font-family: "Hiragino Kaku Gothic ProN", "Yu Gothic", "Meiryo",sans-serif;
  margin:0;
  background:var(--bg);
  color:#222;
  padding:20px;
  display:flex;
  justify-content:center;
}
.wrap{
  width:100%;
  max-width:var(--max-width);
}
header{
  display:flex;
  gap:12px;
  align-items:flex-end;
  margin-bottom:18px;
}
header h1{margin:0;font-size:1.3rem}
.controls{
  margin-left:auto;
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  align-items:center;
}
input[type="search"], select{
  padding:8px 10px;
  border-radius:8px;
  border:1px solid #d6d8df;
  background:var(--card);
}
button{
  padding:8px 12px;
  border-radius:8px;
  border:none;
  background:var(--accent);
  color:white;
  cursor:pointer;
}
button:disabled{opacity:.6;cursor:not-allowed}
main{
  background:transparent;
}
/* ★★★ hidden クラス: 要素を完全に非表示にする ★★★ */
.hidden {
    display: none !important;
}
/* ★★★ list-view クラス: リスト表示時に詳細を非表示にし、コントロールを表示する ★★★ */
/* --- 画面切り替えのコアCSSルール --- */

/* リスト表示時 (.wrapに.list-viewクラスがある場合) */
.wrap.list-view header {
    display: flex; /* ヘッダー（検索、絞り込み）を表示 */
}
.wrap.list-view #recipeTable {
    display: table; /* レシピ一覧テーブルを表示 */
}
.wrap.list-view #message {
    display: block; /* メッセージ/件数表示を表示 */
}
.wrap.list-view #detailContainer {
    display: none !important; /* 詳細コンテナを非表示 */
}

/* 詳細表示時 (.wrapに.detail-viewクラスがある場合) */
.wrap.detail-view header,
.wrap.detail-view #recipeTable,
.wrap.detail-view #message {
    display: none !important; /* リスト表示に必要な要素を全て非表示 */
}
.wrap.detail-view #detailContainer {
    display: block !important; /* 詳細コンテナを確実に表示 */
}
/* ★★★ detail-view クラス: 詳細表示時にリストとコントロールを非表示にする ★★★ */
.detail-view header {
    display: none; /* リストヘッダーを非表示 */
}
.detail-view table {
    display: none; /* テーブルを非表示 */
}


table{
  width:100%;
  border-collapse:collapse;
  background:var(--card);
  border-radius:10px;
  overflow:hidden;
  box-shadow:0 6px 18px rgba(20,20,40,0.06);
}
thead th{
  text-align:left;
  padding:10px 12px;
  font-size:0.85rem;
  background:#f1f5f9;
  border-bottom:1px solid #eee;
  position:sticky;
  top:0;
  z-index:1;
}
/* tbody tdのスタイルをPicture列表示用に上書き・調整 */
tbody td{
  padding:10px 12px;
  border-bottom:1px dashed #eee;
  vertical-align:top;
  font-size:0.95rem;
  text-align: center;
}
/* 画像がある列（3番目）以外は左寄せに戻す */
tbody td:nth-child(1), /* No */
tbody td:nth-child(2), /* Type */
tbody td:nth-child(4), /* Title / flavortxt */
tbody td:nth-child(5), /* 魚 / 旬 */
tbody td:nth-child(6), /* 難易度 / 時間 */
tbody td:nth-child(7), /* 費用 / その他情報 */
tbody td:nth-child(8){ /* 操作 */
  text-align: left;
}
tbody tr:hover{background:rgba(43,108,176,0.03)}
.muted{color:var(--muted);font-size:0.85rem}
.pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef5ff;color:var(--accent);font-size:0.8rem}
.actions button{margin-right:6px}
.tag-type{padding:4px 8px;border-radius:6px;font-size:0.8rem}
.type-recipe{background:#fff7ed;color:#b45309;border:1px solid #f6e7d0}
.type-pre{background:#f0fff4;color:#2f855a;border:1px solid #d6f7df}
/* Picture列の画像スタイル: 80px */
.recipe-thumb{
  width: 80px;
  height: 80px;
  object-fit: cover;
  border-radius: 4px;
  display: block;
  margin: 0 auto;
  border: 1px solid #eee;
}

/* --- 詳細コンテナ（DOM操作で表示する領域）のスタイル --- */
.detail-container{
    margin-top: 0; /* ページ全体を使うためマージンを削除 */
    padding: 20px;
    background: var(--card);
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}
.detail-header{
    border-bottom: 1px solid #eee;
    padding-bottom: 15px;
    margin-bottom: 15px;
}
.detail-header h2{
    margin: 0 0 5px 0;
    font-size: 1.6rem;
    color: var(--accent);
}
.meta{
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-top: 10px;
    font-size: 0.9rem;
    color: var(--muted);
}
.detail-grid{
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}
.section-title{
    font-size: 1.1rem;
    font-weight: 700;
    color: #222;
    margin: 10px 0 6px 0;
}
.detail-section ul, .detail-section ol{
    padding-left: 20px;
    margin-top: 5px;
}
.detail-section pre{
    white-space: pre-wrap;
    background: #f8fafc;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #eef2f7;
}
@media (max-width:700px){
    .detail-grid{grid-template-columns:1fr}
}
/* リストに戻るボタンのスタイル */
.back-button {
    background: var(--muted);
    color: white;
    padding: 8px 12px;
    border-radius: 8px;
    margin-bottom: 15px;
    float: right; /* タイトルと並べる場合はfloatかflexを使いますが、今回は目立たせるため独立させます */
}
/* floatを解除 */
.detail-header::after {
    content: "";
    display: table;
    clear: both;
}

.detail-picture-box {
    margin: 10px 0 15px 0;
    text-align: center;
    border: 1px solid #eef;
    padding: 8px;
    border-radius: 8px;
    background: #fcfcfc;
}
.detail-picture-box img {
    max-width: 100%;
    max-height: 250px;
    width: auto;
    object-fit: contain;
    border-radius: 4px;
    display: block;
    margin: 0 auto;
}
.recipe-step-picture {
    margin: 8px 0;
    text-align: center;
}
.recipe-step-picture img {
    max-width: 100%;
    max-height: 200px;
    width: auto;
    object-fit: contain;
    border-radius: 4px;
    border: 1px dashed #eee;
}  
  
.notice{padding:12px;border-radius:8px;background:#fff3f3;color:var(--danger);border:1px solid rgba(197,48,48,0.12);margin-bottom:12px}
</style>
</head>
<body>
<div class="wrap"　list-view" id="wrap">
    <header>
        <h1>魚レシピ / 下処理管理</h1>
        <div class="controls">
            <input type="search" id="q" placeholder="タイトル, 材料, 魚名などで検索">
            <select id="filterType">
                <option value="all">全て</option>
                <option value="recipe">レシピ</option>
                <option value="pre">下処理</option>
            </select>
            <select id="sortBy">
                <option value="No">No (昇順)</option>
                <option value="-No">No (降順)</option>
                <option value="fish-name">魚名</option>
                <option value="-difficulty">難易度 (難し)</option>
                <option value="difficulty">難易度 (易し)</option>
                <option value="time">時間 (短)</option>
                <option value="-time">時間 (長)</option>
                <option value="-cost">費用 (高)</option>
                <option value="cost">費用 (安)</option>
            </select>
            <button id="reloadBtn">データ再読み込み</button>
        </div>
    </header>

<main id="app">
    <p id="message" class="muted">データを読み込み中です...</p>
    
    <table id="recipeTable">
        <thead>
            <tr>
                <th style="width:80px">No</th>
                <th style="width:80px">Type</th>
                <th style="width:80px">Picture</th> 
                <th>Title / flavortxt</th>
                <th style="width:160px">魚 / 旬</th>
                <th style="width:120px">難易度 / 時間</th>
                <th style="width:120px">費用 / その他情報</th>
                <th style="width:110px">操作</th>
            </tr>
        </thead>
        <tbody id="tbody">
            </tbody>
    </table>

    <div id="detailContainer" class="detail-container hidden">
        <div class="detail-header">
            <button id="backToListBtn" class="back-button">← リストに戻る</button>
            <h2 id="detailTitle"></h2>
            <div id="detailSubtitle" class="muted"></div>
            <div id="detailImageContainer" style="text-align: center; margin-bottom: 15px;"></div>
            <div id="detailMeta" class="meta"></div>
        </div>
        
<div class="detail-grid">
            <div class="detail-section">
                <h3 class="section-title">材料 (Ingredients)</h3>
                <div id="detailIngredientsPicture" class="detail-picture-box"></div>
                <div id="detailIngredients"></div>
            </div>
            <div class="detail-section">
                <h3 class="section-title">道具 (Props)</h3>
                <div id="detailPropsPicture" class="detail-picture-box"></div>
                <div id="detailProps"></div>
            </div>
            <div class="detail-section">
                <h3 class="section-title">下処理・調理法 (Recipe / Pre-Process)</h3>
                <div id="detailRecipe"></div>
            </div>
        </div>
        
        <div class="detail-section">
            <h3 class="section-title">メモ (Memo)</h3>
            <div id="detailMemo"></div>
        </div>
        
        <div class="detail-section">
            <h3 class="section-title">写真リンク / JSONデータ (Debug)</h3>
            <div id="detailPictures"></div>
        </div>
    </div>
</main>
</div>
  <script>
/*
  expectations:
   - JSON is an object with keys: "recipes" and "preparations"
   - We'll attempt several common paths to find the JSON on GitHub Pages.
   - Defensive coding: many fields may be missing; we'll fallback to sensible defaults.
*/

(function(){
    const tryPaths = [
        'docs/recipes.json',
        './docs/recipes.json',
        '/recipes.json',
        './recipes.json'
    ];

    const wrap = document.getElementById('wrap');
    const tbody = document.getElementById('tbody');
    const qInput = document.getElementById('q');
    const filterType = document.getElementById('filterType');
    const sortBy = document.getElementById('sortBy');
    const reloadBtn = document.getElementById('reloadBtn');
    const message = document.getElementById('message');

    // 詳細コンテナの要素
    const detailContainer = document.getElementById('detailContainer');
    const detailTitle = document.getElementById('detailTitle');
    const detailSubtitle = document.getElementById('detailSubtitle');
    const detailImageContainer = document.getElementById('detailImageContainer');
    const detailMeta = document.getElementById('detailMeta');
    const detailIngredients = document.getElementById('detailIngredients');
  　const detailIngredientsPicture = document.getElementById('detailIngredientsPicture'); // ★ 追加
    const detailRecipe = document.getElementById('detailRecipe');
    const detailMemo = document.getElementById('detailMemo');
    const detailPictures = document.getElementById('detailPictures');
    const backToListBtn = document.getElementById('backToListBtn'); // ★ 新しいボタン
  　const detailProps = document.getElementById('detailProps');
  　const detailPropsPicture = document.getElementById('detailPropsPicture'); // ★ 追加
    let rawData = null;
    let flatList = []; // merged list with type annotation
    let currentRawPath = null;
    
    // ★★★ 画面切り替えのコア関数 ★★★
    function showList(){
        wrap.classList.remove('detail-view');
        wrap.classList.add('list-view');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function showDetail(){
        wrap.classList.remove('list-view');
        wrap.classList.add('detail-view');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Utility: safe text node creation
    function elText(tag, text, cls){
        const el = document.createElement(tag);
        if (cls) el.className = cls;
        el.textContent = (text === undefined || text === null) ? '' : String(text);
        return el;
    }

    // Try fetching from multiple paths in order
    async function fetchAny(paths){
        for (const p of paths){
            try {
                const res = await fetch(p, {cache: "no-store"});
                if (!res.ok) continue;
                const json = await res.json();
                currentRawPath = p;
                return json;
            } catch(e){
                // continue to next path
                console.warn('fetch failed for', p, e);
            }
        }
        throw new Error('recipes.json を見つけられませんでした。期待する場所: ' + paths.join(', '));
    }

    // Normalize and flatten recipes + preparations into an array for table
    function buildFlatList(data){
        const list = [];
        if (!data || typeof data !== 'object') return list;

        // recipes
        const recipes = data.recipes || {};
        for (const key of Object.keys(recipes)){
            const item = Object.assign({}, recipes[key]);
            item._type = 'recipe';
            // ensure No is string
            item.No = item.No != null ? String(item.No) : String(key);
            item._origKey = key;
            list.push(item);
        }
        // preparations
        const pres = data.preparations || {};
        for (const key of Object.keys(pres)){
            const item = Object.assign({}, pres[key]);
            item._type = 'pre';
            item.No = item.No != null ? String(item.No) : String(key);
            item._origKey = key;
            list.push(item);
        }
        return list;
    }

    // safe join array-like fields for display
    function joinIfArray(val){
        if (Array.isArray(val)) return val.join(', ');
        if (val === undefined || val === null) return '';
        return String(val);
    }

    function clearTable(){ tbody.innerHTML = ''; }

    // render table rows from list
    function renderTable(list){
        clearTable();
        if (!Array.isArray(list) || list.length === 0){
            tbody.innerHTML = '<tr><td colspan="8" class="muted" style="padding:20px;text-align:center">表示するレシピがありません。</td></tr>'; 
            return;
        }
        const fragment = document.createDocumentFragment();
        for (const item of list){
            const tr = document.createElement('tr');

            // No
            const tdNo = document.createElement('td');
            tdNo.textContent = item.No || '-';
            tr.appendChild(tdNo);

            // Type
            const tdType = document.createElement('td');
            const span = document.createElement('span');
            span.className = 'tag-type ' + (item._type === 'pre' ? 'type-pre' : 'type-recipe');
            span.textContent = item._type;
            tdType.appendChild(span);
            tr.appendChild(tdType);
            
            // Picture
            const tdPicture = document.createElement('td');
            const img = document.createElement('img');
            img.className = 'recipe-thumb';
            
            const firstPic = (Array.isArray(item.pictures) && item.pictures.length > 0) ? item.pictures[0] : null;
            
            let imgSrc = '';
            if (firstPic && typeof firstPic === 'string'){
                imgSrc = firstPic;
            } else {
                // null または配列が存在しない場合、代替画像を表示
                imgSrc = 'https://0128-game.github.io/Fish-recipe/picture/noimage.png';
            }
            
            img.src = imgSrc;
            img.alt = item.title || '画像';
            tdPicture.appendChild(img);
            tr.appendChild(tdPicture);

            // Title and flavortxt
            const tdTitle = document.createElement('td');
            const title = elText('div', item.title || '(タイトルなし)', ''); title.style.fontWeight='700';
            const flav = elText('div', item.flavortxt || '', 'muted');
            tdTitle.appendChild(title);
            tdTitle.appendChild(flav);
            tr.appendChild(tdTitle);

            // fish / season
            const tdFish = document.createElement('td');
            tdFish.appendChild(elText('div', joinIfArray(item['fish-name']) || '-', ''));
            tdFish.appendChild(elText('div', joinIfArray(item.season) || '', 'muted'));
            tr.appendChild(tdFish);

            // difficulty / time
            const tdDiff = document.createElement('td');
            tdDiff.appendChild(elText('div', '難易度: ' + (item.difficulty != null ? item.difficulty : '-')));
            tdDiff.appendChild(elText('div', '所要: ' + (item.time != null ? item.time + '分' : '-'), 'muted'));
            tr.appendChild(tdDiff);

            // cost / info line
            const tdCost = document.createElement('td');
            tdCost.appendChild(elText('div', '¥' + (item.cost != null ? item.cost : '-')));
            const infoLine = (item._type === 'recipe')
                ? ('食事: ' + (item.timing || '-'))
                : ('特徴: ' + joinIfArray(item.feature));
            tdCost.appendChild(elText('div', infoLine, 'muted'));
            tr.appendChild(tdCost);

            // actions
            const tdActions = document.createElement('td');
            tdActions.className = 'actions';
            
            // 詳細ボタン
            const viewBtn = document.createElement('button');
            viewBtn.textContent = '詳細';
            
            // ★★★ displayDetail関数を呼び出すリスナーを設定し、詳細画面に切り替える ★★★
            viewBtn.addEventListener('click', ()=> displayDetail(item));
            
            tdActions.appendChild(viewBtn);

            // quick copy JSON button
            const copyBtn = document.createElement('button');
            copyBtn.textContent = 'JSON';
            copyBtn.style.background = '#6b7280';
            copyBtn.addEventListener('click', ()=> {
                const blob = new Blob([JSON.stringify(item, null, 2)], {type:'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `item-${item.No || item._origKey}.json`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
            });
            tdActions.appendChild(copyBtn);

            tr.appendChild(tdActions);
            fragment.appendChild(tr);
        }
        tbody.appendChild(fragment);
    }

    // Utility: 画像を表示するエレメントを作成する関数
    function createPictureElement(src, altText) {
        if (!src || src === 'null') return null;
        
        const img = document.createElement('img');
        img.src = src;
        img.alt = altText || '画像';
        return img;
    }

    // 詳細情報を同じページ内のコンテナに表示する関数
    function displayDetail(item){
        
        // 1. 画面を詳細表示に切り替える
        showDetail(); 

        // 2. 画像パスの割り当てとフォールバック
        const pictures = item.pictures || [];
        const thumbPic = pictures[0] || 'https://0128-game.github.io/Fish-recipe/picture/noimage.png';

        // 0: サムネイル画像 (メイン画像に使用) -> thumbPic
        // 1: 材料画像 -> ingredientsPic (nullの場合はサムネイルにフォールバック)
        const ingredientsPic = pictures[1] || thumbPic;
        // 2: 道具画像 -> propsPic (type:"pre"の時のみ使用。nullの場合はサムネイルにフォールバック)
        const propsPic = pictures[2] || thumbPic;
        // 3~: 手順画像 -> stepPictures

        // 3. ヘッダー情報 (変更なし)
        detailTitle.textContent = (item.title || '(タイトルなし)') + ' — No.' + item.No;
        detailSubtitle.textContent = item.flavortxt || '';

        // 4. メタ情報 (変更なし)
        detailMeta.innerHTML = '';
        detailMeta.appendChild(elText('div', 'タイプ: ' + (item._type || '-'), 'pill'));
        detailMeta.appendChild(elText('div', '魚: ' + joinIfArray(item['fish-name']) , 'pill'));
        detailMeta.appendChild(elText('div', '旬: ' + joinIfArray(item.season), 'pill'));
        detailMeta.appendChild(elText('div', '難易度: ' + (item.difficulty != null ? item.difficulty : '-'), 'pill'));
        detailMeta.appendChild(elText('div', '費用: ' + (item.cost != null ? '¥' + item.cost : '-'), 'pill'));
        detailMeta.appendChild(elText('div', '所要時間: ' + (item.time != null ? item.time + '分' : '-'), 'pill'));
        detailMeta.appendChild(elText('div', '下処理参照: ' + (item['pre-recipe'] || '-'), 'pill'));

        // 5. メイン画像 (サムネイル: pictures[0])
        detailImageContainer.innerHTML = '';
        const mainImg = createPictureElement(thumbPic, item.title);
        if (mainImg) {
            mainImg.style.maxWidth = '100%';
            mainImg.style.maxHeight = '250px'; 
            mainImg.style.width = 'auto';
            mainImg.style.objectFit = 'contain';
            mainImg.style.borderRadius = '8px';
            mainImg.style.border = '1px solid #ddd';
            detailImageContainer.appendChild(mainImg);
        }

        // 6. 材料 (Ingredients) + 材料画像 (pictures[1])
        detailIngredientsPicture.innerHTML = '';
        const ingPicEl = createPictureElement(ingredientsPic, item.title + ' 材料');
        if (ingPicEl) detailIngredientsPicture.appendChild(ingPicEl);

        detailIngredients.innerHTML = '';
        const ing = item.ingredients || {};
        if (Object.keys(ing).length === 0){
            detailIngredients.appendChild(elText('div','(材料なし)','muted'));
        } else {
            const ul = document.createElement('ul');
            for (const k of Object.keys(ing)){
                const li = document.createElement('li');
                li.textContent = k + ': ' + (ing[k] || '');
                ul.appendChild(li);
            }
            detailIngredients.appendChild(ul);
        }

        // 7. 道具 (Props) + 道具画像 (pictures[2])
        detailPropsPicture.innerHTML = '';
        detailProps.innerHTML = ''; 
        const props = item.props || {};

        if (item._type === 'pre') {
            // type: "pre" の時のみ道具画像を表示
            const propsPicEl = createPictureElement(propsPic, item.title + ' 道具');
            if (propsPicEl) detailPropsPicture.appendChild(propsPicEl);

            if (Object.keys(props).length === 0){
                detailProps.appendChild(elText('div', '(道具なし)', 'muted'));
            } else {
                const ul = document.createElement('ul');
                for (const k of Object.keys(props)){
                    const li = document.createElement('li');
                    li.textContent = k + ': ' + (props[k] || '');
                    ul.appendChild(li);
                }
                detailProps.appendChild(ul);
            }
        } else {
            // type: "recipe" の時は道具セクションを非表示にする
            detailProps.closest('.detail-section').style.display = 'none';
        }

        // 8. 手順 (Recipe / Pre-Process) + 手順画像 (pictures[3]~)
        detailRecipe.innerHTML = '';
        const rec = item.recipe || [];
        
        if (!Array.isArray(rec) || rec.length === 0){
            detailRecipe.appendChild(elText('div','(手順なし)','muted'));
        } else {
            const ol = document.createElement('ol');
            for (let i = 0; i < rec.length; i++){
                const step = rec[i];
                const li = document.createElement('li');
                li.textContent = step;

                // 手順画像: pictures[3]から順番に取得
                const stepPicIndex = i + 3;
                const stepPicSrc = pictures[stepPicIndex];

                // null (または未定義)の場合は画像を表示しない
                if (stepPicSrc && stepPicSrc !== 'null') {
                    const picContainer = document.createElement('div');
                    picContainer.className = 'recipe-step-picture';
                    const stepImg = createPictureElement(stepPicSrc, `手順${i + 1}の画像`);
                    if (stepImg) picContainer.appendChild(stepImg);
                    li.appendChild(picContainer);
                }
                
                ol.appendChild(li);
            }
            detailRecipe.appendChild(ol);
        }
        // type: "recipe" でない場合は道具セクションを表示に戻す（他の表示に影響させないため）
        if (item._type !== 'pre') detailProps.closest('.detail-section').style.display = 'block';


        // 9. メモ (Memo) (変更なし)
        detailMemo.innerHTML = '';
        const memo = item.memo || [];
        if (!Array.isArray(memo) || memo.length === 0){
            detailMemo.appendChild(elText('div','(メモなし)','muted'));
        } else {
            const ulm = document.createElement('ul');
            for (const m of memo){
                ulm.appendChild(elText('li', m));
            }
            detailMemo.appendChild(ulm);
        }

        // 10. 写真リンク / JSONデータ (Debug) (変更なし)
        detailPictures.innerHTML = '';
        const debugPics = item.pictures || [];
        if (Array.isArray(debugPics) && debugPics.length){
            const lines = debugPics.map((p,i)=> (p === null ? `[${i}] null` : `[${i}] ${p}`));
            detailPictures.appendChild(elText('pre', lines.join('\n')));
        } else {
            detailPictures.appendChild(elText('div', '(pictures なし)', 'muted'));
        }
    }
    // filter/sort logic
    function applyFiltersAndRender(){
        // ... (省略) ...
        const q = (qInput.value || '').trim().toLowerCase();
        const type = filterType.value;
        const sortVal = sortBy.value;

        let list = flatList.slice();

        // filter by type
        if (type !== 'all') list = list.filter(i => i._type === type);

        // search across several fields (強化された部分)
        if (q){
            list = list.filter(item => {
                // 検索対象のフィールドを全て結合
                const parts = [
                    item.title, item.flavortxt,
                    joinIfArray(item['fish-name']),
                    joinIfArray(item.feature),
                    joinIfArray(item.season),
                    item.No,
                    // 材料のキー名（例: サバ, 味噌）
                    Object.keys(item.ingredients || {}).join(' '),
                    // 手順 (recipe)
                    joinIfArray(item.recipe),
                    // メモ (memo)
                    joinIfArray(item.memo),
                    // 道具 (props, preのみ)
                    joinIfArray(item.props)
                ];
                const hay = parts.filter(Boolean).join(' ').toLowerCase();
                return hay.includes(q);
            });
        }

        // sort
        const desc = sortVal.startsWith('-');
        const key = desc ? sortVal.slice(1) : sortVal;
        list.sort((a,b)=>{
            // numeric-aware where possible
            const av = a[key];
            const bv = b[key];
            // No の並び替えロジックの改善 (P1, P2, 1, 2)
            if (key === 'No'){
                // "P1" -> 1.5, "1" -> 1 のようにしてPと数字を分離して比較
                const extractNum = (val) => {
                    const s = String(val||'');
                    const isPre = s.startsWith('P');
                    const num = parseInt(s.replace(/^P/,'') || '0', 10);
                    // 'P' 付きは .5 で表現して通常の番号より前に来るようにする
                    return isPre ? num + 0.5 : num;
                };
                const na = extractNum(av);
                const nb = extractNum(bv);
                return desc ? nb - na : na - nb;
            }
            const an = (av == null) ? Number.POSITIVE_INFINITY : Number(av);
            const bn = (bv == null) ? Number.POSITIVE_INFINITY : Number(bv);
            if (!isFinite(an) || !isFinite(bn)){
                // fallback string compare
                return desc ? String(bv).localeCompare(String(av)) : String(av).localeCompare(String(bv));
            }
            return desc ? bn - an : an - bn;
        });

        renderTable(list);
        message.textContent = `${list.length} 件の結果を表示中 (全 ${flatList.length} 件)`;
    }

    // reload button
    reloadBtn.addEventListener('click', ()=> {
        loadData();
    });
    
    // ★★★ リストに戻るボタンのイベントリスナー ★★★
    backToListBtn.addEventListener('click', ()=> {
        showList();
    });

    qInput.addEventListener('input', ()=> applyFiltersAndRender());
    filterType.addEventListener('change', ()=> applyFiltersAndRender());
    sortBy.addEventListener('change', ()=> applyFiltersAndRender());

    // main loader
    async function loadData(){
        message.textContent = '読み込み中...';
        try {
            const json = await fetchAny(tryPaths);
            rawData = json;
            flatList = buildFlatList(json);
            if (flatList.length === 0){
                message.innerHTML = '<div class="notice">recipes または preparations のデータが空です。docs/recipes.json を確認してください。</div>';
            } else {
                message.textContent = `読み込み完了 — 合計 ${flatList.length} 件（recipes: ${Object.keys(json.recipes||{}).length}, preparations: ${Object.keys(json.preparations||{}).length}）`;
            }
            applyFiltersAndRender();
            // データロード完了後、初期表示はリスト画面にする
            showList();
        } catch (err){
            console.error(err);
            message.innerHTML = '<div class="notice">読み込みエラー: ' + String(err.message) + '</div>';
            clearTable();
            // エラー時は詳細画面は表示しない
            wrap.classList.remove('detail-view');
        }
    }

    // initial load
    loadData();

    // Expose for debug on window
    window._recipesApp = {
        loadData,
        getRaw: ()=> rawData,
        getFlat: ()=> flatList
    };
})();
</script>
</body>
</html>
